---
title: "result_analysis"
author: "Robert Riddell"
date: "09/08/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(caret)
```

```{r}
game_total <- read_csv("out/game_total.csv")
game_total <- game_total %>% 
  select(!c(id, date, game_number))
```

```{r}

inTrain <- createDataPartition(y = game_total$results, p = 0.7, list = F)
training <-  game_total %>% 
  slice(inTrain)

testing <-  game_total %>% 
  slice(-inTrain)
```

```{r}
gg_boxplot <- function(feature){
  ggplot(training, aes(results,.data[[feature]], fill = results))+
    geom_boxplot()
}

numeric_vars <- training %>% 
  select(where(is.numeric), -results) %>% 
  names(.)

for (i in seq_along(numeric_vars)) {
  print(gg_boxplot(numeric_vars[i]))
}
```

```{r}
gg_barplot <- function(feature){
  ggplot(training, aes(.data[[feature]], fill = results))+
    geom_bar(position = 'stack')+
    xlab(paste(feature))+
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
}

char_vars <- training %>% 
  select(where(is.character), -results) %>% 
  names(.)

for (i in char_vars) {
  print(gg_barplot(i))
}
```

```{r}
nearZeroVar(training, names = T)
```

```{r}
cor_mat <- training %>% 
  select(where(is.numeric)) %>% 
  cor(., method = 'spearman')

GGally::ggcorr(cor_mat)
cor_features <- findCorrelation(cor_mat, cutoff = 0.8, names = T, exact = FALSE)
training <- training %>% 
  select(-cor_features)
```

```{r}
control_obj <- trainControl(
  method = "repeatedcv",
  number = 10,
  repeats = 5,
  savePredictions = "final",
  classProbs = T, 
  summaryFunction = twoClassSummary
)

```

```{r}
set.seed(345)
mdl_logreg <- train(results ~.,
                    data = training,
                    method = "glm",
                    family = 'binomial',
                    trControl = control_obj)
mdl_logreg
confusionMatrix(data = mdl_logreg,
                reference = training$shot_result,
                positive = "W")

plot(varImp(mdl_logreg), top = 20)

```

```{r}
set.seed(345)

tree_mdl  <- train(results ~. , data = training ,
                   method = 'rpart',
                   tuneGrid = expand.grid(cp = seq(0.001,0.004,0.0001)),
                   trControl = control_obj,
                   metric = "ROC")

tree_mdl
plot(tree_mdl)
rattle::fancyRpartPlot(tree_mdl$finalModel, sub = "", palettes = 'RdBu')
plot(varImp(tree_mdl), top =20)

confusionMatrix(data = tree_mdl,
                reference = training$shot_result,
                positive = "W")

```

```{r}
set.seed(345)

rf_mdl  <- train(results ~. , data = training ,
                 method = 'ranger',
                 trControl = control_obj,
                 verbose = FALSE)


rf_mdl
plot(rf_mdl)
confusionMatrix(data = rf_mdl,
                reference = training$shot_result,
                positive = "W")

```

```{r}
resamps <- resamples(list(tree = tree_mdl,
                          rf = rf_mdl,
                          logreg = mdl_logreg))

bwplot(resamps)
summary(resamps)
```

```{r}
predictions_logreg <- predict(mdl_logreg, newdata = testing, type = "raw")

prob_logreg <- predict(mdl_logreg, newdata = testing, type = "prob")

confusionMatrix(data = predictions_logreg,
                reference = factor(testing$results),
                positive = "W")

result_binary <- if_else(testing$results == "W",1,0)

prob_logreg <- prob_logreg %>% 
  select('W') %>% 
  unlist() %>% 
  unname()

pROC::roc(response = result_binary,
          predictor = prob_logreg,
          ci = T,
          plot = T,
          legacy.axes = T,
          print.auc = T,
          print.thres = 0.5,
          asp = NA)

```

